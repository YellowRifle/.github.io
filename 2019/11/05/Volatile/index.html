<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Volatile | YellowRifle Thinking</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="YellowRifle"><meta name="designer" content="minfive"><meta name="keywords" content="java,golang,日常分享,阿美咔叽,篮球"><meta name="description" content="undefined"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://yellowrifle.github.io/2019/11/05/Volatile/index.html"><link rel="icon" type="image/png" href="/images/websource/avator.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="YellowRifle" type="application/atom+xml"><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 5.1.1"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/images/websource/giphy.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="YellowRifle" alt="YellowRifle"><img src="/images/websource/icon.png" alt="YellowRifle"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/images/lock/volatile/headindex.png" alt="Volatile"></div><header class="post__info"><h1 class="post__title">Volatile</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">YellowRifle</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2019-11-05</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Volatile/">Volatile</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-eye"></i><ul class="mark__list clearfix"><li id="busuanzi_container_page_pv" class="mark__item"><span id="busuanzi_value_page_pv"></span>次</li></ul></div></div></header><div class="post__content"><h2 id="并发编程的三个特性"><a href="#并发编程的三个特性" class="headerlink" title="并发编程的三个特性"></a>并发编程的三个特性</h2><p>volatile 虽然从字面意思上理解比较简单，但是在实际环境中能正确的使用该变量并不容易，只有了解其背后的原理，我们才能发挥出这个关键字的重要作用。在理解原理之前，我们有必要先了解一下并发编程中三个常见的概念：原子性、可见性和顺序一致性。</p><p><strong>原子性</strong><br>原子性理解比较简单，与数据库系统中原子性意思基本一致，即一个操作或者多个操作要么全部执行并且执行的过程不会被任何因素打断，要么就都不执行。<br>一个很经典的例子就是银行账户转账问题：<br>比如从账户 A 向账户 B 转 1000 元，那么必然包括 2 个操作：从账户 A 减去 1000 元，往账户 B 加上 1000 元。<br>试想一下，如果这 2 个操作不具备原子性，会造成什么样的后果。假如从账户 A 减去 1000 元之后，操作突然中止。然后又从 B 取出了 500 元，取出 500 元之后，再执行往账户 B 加上 1000 元的操作。这样就会导致账户 A 虽然减去了 1000 元，但是账户 B 没有收到这个转过来的 1000 元。<br>所以这 2 个操作必须要具备原子性才能保证不出现一些意外的问题。<br>同样地反映到并发编程中会出现什么结果呢？<br>举个最简单的例子，大家想一下假如为一个 64 位的变量赋值过程不具备原子性的话，会发生什么后果？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">long i &#x3D; 9L;</span><br></pre></td></tr></table></figure><p>假若一个线程执行到这个语句时，我暂且假设为一个 64 位的变量赋值包括两个过程：为低 32 位赋值，为高 32 位赋值。那么就可能发生一种情况：当将低 32 位数值写入之后，突然被中断，而此时又有一个线程去读取 i 的值，那么读取到的就是错误的数据。</p><p><strong>可见性</strong><br>可见性是指当多个线程访问同一个变量时，一个线程修改了这个变量的值，其他线程能够立即看得到修改的值。</p><p>举个简单的例子，看下面这段代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;线程1执行的代码</span><br><span class="line">int i &#x3D; 0;</span><br><span class="line">i &#x3D; 10;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;线程2执行的代码</span><br><span class="line">j &#x3D; i;</span><br></pre></td></tr></table></figure><p>　　假若执行线程1的是CPU1，执行线程2的是CPU2。由上面的分析可知，当线程1执行 i =10这句时，会先把i的初始值加载到CPU1的高速缓存中，然后赋值为10，那么在CPU1的高速缓存当中i的值变为10了，却没有立即写入到主存当中。</p><p>　　此时线程2执行 j = i，它会先去主存读取i的值并加载到CPU2的缓存当中，注意此时内存当中i的值还是0，那么就会使得j的值为0，而不是10.</p><p>　　这就是可见性问题，线程1对变量i修改了之后，线程2没有立即看到线程1修改的值。</p><p><strong>顺序一致性</strong><br>即程序执行的顺序按照代码的先后顺序执行。举个简单的例子，看下面这段代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int i &#x3D; 0;              </span><br><span class="line">boolean flag &#x3D; false;</span><br><span class="line">i &#x3D; 1;                &#x2F;&#x2F;语句1  </span><br><span class="line">flag &#x3D; true;          &#x2F;&#x2F;语句2</span><br></pre></td></tr></table></figure><p>上面代码定义了一个 int 型变量，定义了一个 boolean 类型变量，然后分别对两个变量进行赋值操作。从代码顺序上看，语句 1 是在语句 2 前面的，那么 JVM 在真正执行这段代码的时候会保证语句 1 一定会在语句 2 前面执行吗？不一定，为什么呢？这里可能会发生指令重排序（Instruction Reorder）。</p><p>下面解释一下什么是指令重排序，一般来说，处理器为了提高程序运行效率，可能会对输入代码进行优化，它不保证程序中各个语句的执行先后顺序同代码中的顺序一致，但是它会保证程序最终执行结果和代码顺序执行的结果是一致的。</p><p>比如上面的代码中，语句 1 和语句 2 谁先执行对最终的程序结果并没有影响，那么就有可能在执行过程中，语句 2 先执行而语句 1 后执行。</p><h2 id="Volatile是什么"><a href="#Volatile是什么" class="headerlink" title="Volatile是什么?"></a>Volatile是什么?</h2><p>在Sun的JDK官方文档是这样形容volatile的：</p><p>The Java programming language provides a second mechanism, volatile fields, that is more convenient than locking for some purposes. A field may be declared volatile, in which case the Java Memory Model ensures that all threads see a consistent value for the variable.</p><p>大意就说，如果一个变量加了volatile关键字，就会告诉编译器和JVM的内存模型：这个变量是对所有线程共享的、可见的，每次jvm都会读取最新写入的值并使其最新值在所有CPU可见。volatile似乎是有时候可以代替简单的锁，似乎加了volatile关键字就省掉了锁。但又说volatile不能保证原子性（java程序员很熟悉这句话：volatile仅仅用来保证该变量对所有线程的可见性，但不保证原子性）。</p><h2 id="Volatile实现原理"><a href="#Volatile实现原理" class="headerlink" title="Volatile实现原理"></a>Volatile实现原理</h2><p><img src="/images/lock/volatile/volatile.png"></p><h2 id="常见问题-volatile为什么不能保证原子性"><a href="#常见问题-volatile为什么不能保证原子性" class="headerlink" title="常见问题 volatile为什么不能保证原子性"></a>常见问题 volatile为什么不能保证原子性</h2><p>就比如在多线程中，多个线程对于一个实例变量的变量i进行自增操作，例如i++，这时候就产生了竞态条件导致，例如给i变量加5000次，得到的结果可能是5000得到的结果也可能是少于5000，尽管你加了volatile，这是为什么呢？要知道volatile仅是通过内存屏障的机制来保障</p><p>例如</p><p>load1;load2;store1;store2;StoreLoad;load3;store3…..</p><p>尽管你保证了可见性，但你不能保证该操作的原子性，所谓的原子性本质就是指令在执行期间不被打断，要么就是不执行，仔细想想i++是不是一个三步的复合操作：取值、相加、赋值，就比如：你在未赋值时别的线程执行时，别的线程也正在处以赋值状态,尽管你保障了可见性，但你并不能保证你拿到手上的值永远是最新值</p><h2 id="Volatile的使用方法及场景"><a href="#Volatile的使用方法及场景" class="headerlink" title="Volatile的使用方法及场景"></a>Volatile的使用方法及场景</h2><div class="post-announce">感谢您的阅读，本文由 <a href="https://yellowrifle.github.io">YellowRifle</a> 版权所有。如若转载，请注明出处：YellowRifle（<a href="https://yellowrifle.github.io/2019/11/05/Volatile/">https://yellowrifle.github.io/2019/11/05/Volatile/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2019/11/05/ThreadLocal/" title="ThreadLocal"><i class="iconfont icon-prev"></i>ThreadLocal</a></div><div class="post__prev post__prev--right"><a href="/2019/11/05/Sychronized/" title="Sychronized(对象锁)">Sychronized(对象锁)<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%9D%82%E9%A1%B9/">杂项</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Web/">Web</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Redis/">Redis</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Java/">Java</a><span class="block-list-count">7</span><ul class="block-list-child"><li class="block-list-item"><a class="block-list-link" href="/categories/Java/Java-Lock/">Java Lock</a><span class="block-list-count">3</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Java/Java-Basic/">Java Basic</a><span class="block-list-count">3</span></li></ul></li><li class="block-list-item"><a class="block-list-link" href="/categories/Gradle/">Gradle</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Golang/">Golang</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Algorithm/">Algorithm</a><span class="block-list-count">3</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2020/09/01/hello-world/" title="Hello World"><div class="item__cover"><img src="undefined" alt="Hello World"></div><div class="item__info"><h3 class="item__title">Hello World</h3><span class="item__text">2020-09-01</span></div></a></li><li class="latest-post-item"><a href="/2019/11/11/%E9%98%BF%E9%87%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8/" title="阿里服务器使用"><div class="item__cover"><img src="images/杂项/alibaba/headindex.png" alt="阿里服务器使用"></div><div class="item__info"><h3 class="item__title">阿里服务器使用</h3><span class="item__text">2019-11-11</span></div></a></li><li class="latest-post-item"><a href="/2019/11/05/Sychronized/" title="Sychronized(对象锁)"><div class="item__cover"><img src="/images/lock/Sychronized/headindex.jpg" alt="Sychronized(对象锁)"></div><div class="item__info"><h3 class="item__title">Sychronized(对象锁)</h3><span class="item__text">2019-11-05</span></div></a></li><li class="latest-post-item"><a href="/2019/11/05/Volatile/" title="Volatile"><div class="item__cover"><img src="/images/lock/volatile/headindex.png" alt="Volatile"></div><div class="item__info"><h3 class="item__title">Volatile</h3><span class="item__text">2019-11-05</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Garbage-Collector/">Garbage Collector</a></li><li class="tag-item"><a class="tag-link" href="/tags/Gradle/">Gradle</a></li><li class="tag-item"><a class="tag-link" href="/tags/Lock/">Lock</a></li><li class="tag-item"><a class="tag-link" href="/tags/NIO/">NIO</a></li><li class="tag-item"><a class="tag-link" href="/tags/OOP/">OOP</a></li><li class="tag-item"><a class="tag-link" href="/tags/Redis/">Redis</a></li><li class="tag-item"><a class="tag-link" href="/tags/Sychronized/">Sychronized</a></li><li class="tag-item"><a class="tag-link" href="/tags/Volatile/">Volatile</a></li><li class="tag-item"><a class="tag-link" href="/tags/android/">android</a></li><li class="tag-item"><a class="tag-link" href="/tags/login/">login</a></li><li class="tag-item"><a class="tag-link" href="/tags/sort/">sort</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，主要用于分享日常学习、生活及工作的一些心得总结，欢迎点击右下角订阅 rss。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Chengdu, Sichuan Province, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>984367065@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/images/websource/avator.jpg" alt="logo" title="YellowRifle"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2019 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/YellowRifle" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="984367065@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>