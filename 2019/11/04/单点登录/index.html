<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>单点登录 | YellowRifle Thinking</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="YellowRifle"><meta name="designer" content="minfive"><meta name="keywords" content="java,golang,日常分享,阿美咔叽,篮球"><meta name="description" content="undefined"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://yellowrifle.github.io/2019/11/04/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/index.html"><link rel="icon" type="image/png" href="/images/websource/avator.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="YellowRifle" type="application/atom+xml"><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 5.1.1"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/images/websource/giphy.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="YellowRifle" alt="YellowRifle"><img src="/images/websource/icon.png" alt="YellowRifle"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/images/web/sso/index.png" alt="单点登录"></div><header class="post__info"><h1 class="post__title">单点登录</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">YellowRifle</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2019-11-04</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/login/">Login</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-eye"></i><ul class="mark__list clearfix"><li id="busuanzi_container_page_pv" class="mark__item"><span id="busuanzi_value_page_pv"></span>次</li></ul></div></div></header><div class="post__content"><h2 id="一、业务介绍来源"><a href="#一、业务介绍来源" class="headerlink" title="一、业务介绍来源"></a>一、业务介绍来源</h2><h4 id="早期单一服务器，用户认证"><a href="#早期单一服务器，用户认证" class="headerlink" title="早期单一服务器，用户认证"></a>早期单一服务器，用户认证</h4><p><strong>缺点：单点性能压力，无法扩展</strong><br>早期我们开发web应用都是所有的包放在一起打成一个war包放入tomcat容器来运行的,所有的功能,所有的业务,后台管理,门户界面,都是由这一个war来支持的。</p><p>用户的登录以及权限就显得十分简单,用户登录成功后,把相关信息放入会话中,HTTP维护这个会话,再每次用户请求服务器的时候来验证这个会话即可,大致可以用下图来表示:<br><img src="/images/web/sso/oldMethod.png"></p><p>服务器和客户端的状态是由session来维护的,当集群出现后,各台机器上的Session就会出现不一致的问题,下面来梳理下Session。</p><p><strong>Token和Session</strong><br><em>Session:</em><br>客户端首次请求,服务器生成sessionId,存在服务器上,同时发送一份到客户端,客户端保存在浏览器中,下次访问的时候带上sessionId去访问(放在header里)，服务器验证比对是否存有改Id就能够判断曾经登录与否</p><p><strong>Session存在什么问题:</strong></p><ul><li>cookie中使用jsessionId 容易被篡改、盗取,不法分子直接可以从浏览器中截取出保存的JsessionId,直接可用于登录</li><li>用户量大时空间浪费高</li><li>跨顶级域名无法访问</li><li>严重的限制了服务器扩展能力， 比如说我用两个机器组成了一个集群， 小F通过机器A登录了系统， 那session id会保存在机器A上， 假设小F的下一次请求被转发到机器B怎么办？ 机器B可没有小F的 session id啊。</li></ul><p><strong>Token流程:</strong><br>1.用户通过用户名和密码发送请求。<br>2.程序验证。<br>3.程序返回一个签名的token 给客户端。<br>4.客户端储存token,并且每次用于每次发送请求。<br>5.服务端验证token并返回数据。</p><p><strong>发现Token和Session的区别了吗?</strong><br>Token并不会在服务器上进行保存,而是在服务器上有一套验证逻辑,下一次登录服务器只需要对客户端发来的token进行合法性验证就好了,而session是需要在服务器中保存一个值,服务器对比和客户端请求的值的是否一致。<br>Token:时间换空间<br>Session:空间换时间(社区合法性验证过程)<br><strong>注意这里Session和web中的Session有区别</strong></p><h4 id="SSO单点登录模式-single-sign-on"><a href="#SSO单点登录模式-single-sign-on" class="headerlink" title="SSO单点登录模式(single sign on)"></a>SSO单点登录模式(single sign on)</h4><p>解决了单点性能瓶颈<br>系统架构:<br><img src="/images/web/sso/ssoindex.png"><br><img src="/images/web/sso/sso.png"></p><h2 id="二、实现单点登录"><a href="#二、实现单点登录" class="headerlink" title="二、实现单点登录"></a>二、实现单点登录</h2><h4 id="Step1-生成token"><a href="#Step1-生成token" class="headerlink" title="Step1: 生成token"></a>Step1: 生成token</h4><h5 id="JWT工具"><a href="#JWT工具" class="headerlink" title="JWT工具"></a>JWT工具</h5><p>JWT（Json Web Token） 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准。<br>JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源。比如用在用户登录上<br>JWT 最重要的作用就是对 token信息的防伪作用。</p><h5 id="JWT的组成"><a href="#JWT的组成" class="headerlink" title="JWT的组成"></a>JWT的组成</h5><p>一个JWT由三个部分组成：公共部分、私有部分、签名部分。最后由这三者组合进行base64编码得到JWT。<br><img src="/images/web/sso/jwt.jpeg"></p><p>1、公共部分(Header)<br>主要是该JWT的相关配置参数，比如签名的加密算法、格式类型、过期时间等等。<br>2、私有部分(Payload)<br>用户自定义的内容，根据实际需要真正要封装的信息。<br>3、签名部分(Signature)<br>根据用户信息+盐值+密钥生成的签名。如果想知道JWT是否是真实的只要把JWT的信息取出来，加上盐值和服务器中的密钥就可以验证真伪。所以不管由谁保存JWT，只要没有密钥就无法伪造。<br>4、base64编码，并不是加密，只是把明文信息变成了不可见的字符串。但是其实只要用一些工具就可以吧base64编码解成明文，所以不要在JWT中放入涉及私密的信息，因为实际上JWT并不是加密信息。<br>5、采用HMAC-SHA256进行Hsh加密</p><h4 id="Step2-制作-JWT的工具类（JwtUtil）"><a href="#Step2-制作-JWT的工具类（JwtUtil）" class="headerlink" title="Step2: 制作 JWT的工具类（JwtUtil）"></a>Step2: 制作 JWT的工具类（JwtUtil）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    public class JwtUtil &#123;</span><br><span class="line"></span><br><span class="line">    public static String encode(String key,Map&lt;String,Object&gt; param,String salt)&#123;</span><br><span class="line">        if(salt!&#x3D;null)&#123;</span><br><span class="line">            key+&#x3D;salt;</span><br><span class="line">        &#125;</span><br><span class="line">        JwtBuilder jwtBuilder &#x3D; Jwts.builder().signWith(SignatureAlgorithm.HS256,key);</span><br><span class="line"></span><br><span class="line">        jwtBuilder &#x3D; jwtBuilder.setClaims(param);</span><br><span class="line"></span><br><span class="line">        String token &#x3D; jwtBuilder.compact();</span><br><span class="line">        return token;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public  static Map&lt;String,Object&gt;  decode(String token ,String key,String salt)&#123;</span><br><span class="line">        Claims claims&#x3D;null;</span><br><span class="line">        if (salt!&#x3D;null)&#123;</span><br><span class="line">            key+&#x3D;salt;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            claims&#x3D; Jwts.parser().setSigningKey(key).parseClaimsJws(token).getBody();</span><br><span class="line">        &#125; catch ( JwtException e) &#123;</span><br><span class="line">           return null;</span><br><span class="line">        &#125;</span><br><span class="line">        return  claims;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Step3-建立注册中心"><a href="#Step3-建立注册中心" class="headerlink" title="Step3: 建立注册中心"></a>Step3: 建立注册中心</h4><p>实际项目中,可建立一个模块用作注册中心,如我这里的passport作为注册中心。<br>注册中心主要功能:</p><p><strong>1.验证用户是否合法</strong><br><strong>2.为登录用户颁发token</strong><br><img src="/images/web/sso/passport.png"></p><p>#####登录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;login&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public String login(UmsMember umsMember, HttpServletRequest request)&#123;</span><br><span class="line"></span><br><span class="line">        String token &#x3D; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 调用用户服务验证用户名和密码</span><br><span class="line">        UmsMember umsMemberLogin &#x3D; userService.login(umsMember);</span><br><span class="line"></span><br><span class="line">        if(umsMemberLogin!&#x3D;null)&#123;</span><br><span class="line">            &#x2F;&#x2F; 登录成功</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 用jwt制作token</span><br><span class="line">            String memberId &#x3D; umsMemberLogin.getId();</span><br><span class="line">            String nickname &#x3D; umsMemberLogin.getNickname();</span><br><span class="line">            Map&lt;String,Object&gt; userMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">            userMap.put(&quot;memberId&quot;,memberId);</span><br><span class="line">            userMap.put(&quot;nickname&quot;,nickname);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            String ip &#x3D; request.getHeader(&quot;x-forwarded-for&quot;);&#x2F;&#x2F; 通过nginx转发的客户端ip</span><br><span class="line">            if(StringUtils.isBlank(ip))&#123;</span><br><span class="line">                ip &#x3D; request.getRemoteAddr();&#x2F;&#x2F; 从request中获取ip</span><br><span class="line">                if(StringUtils.isBlank(ip))&#123;</span><br><span class="line">                    ip &#x3D; &quot;127.0.0.1&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 按照设计的算法对参数进行加密后，生成token</span><br><span class="line">            token &#x3D; JwtUtil.encode(&quot;2019gmall0105&quot;, userMap, ip);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 将token存入redis一份</span><br><span class="line">            userService.addUserToken(token,memberId);</span><br><span class="line"></span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            &#x2F;&#x2F; 登录失败</span><br><span class="line">            token &#x3D; &quot;fail&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>#####验证token</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;verify&quot;)</span><br><span class="line">   @ResponseBody</span><br><span class="line">   public String verify(String token,String currentIp,HttpServletRequest request)&#123;</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F; 通过jwt校验token真假</span><br><span class="line">       Map&lt;String,String&gt; map &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">       Map&lt;String, Object&gt; decode &#x3D; JwtUtil.decode(token, &quot;2019gmall0105&quot;, currentIp);</span><br><span class="line"></span><br><span class="line">       if(decode!&#x3D;null)&#123;</span><br><span class="line">           map.put(&quot;status&quot;,&quot;success&quot;);</span><br><span class="line">           map.put(&quot;memberId&quot;,(String)decode.get(&quot;memberId&quot;));</span><br><span class="line">           map.put(&quot;nickname&quot;,(String)decode.get(&quot;nickname&quot;));</span><br><span class="line">       &#125;else&#123;</span><br><span class="line">           map.put(&quot;status&quot;,&quot;fail&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       return JSON.toJSONString(map);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>#####跳转到index登录界面,登录失败时使用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;index&quot;)</span><br><span class="line">   public String index(String ReturnUrl, ModelMap map)&#123;</span><br><span class="line"></span><br><span class="line">       map.put(&quot;ReturnUrl&quot;,ReturnUrl);</span><br><span class="line">       return &quot;index&quot;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h4 id="Step3-业务模块的登录检查-注解与拦截器"><a href="#Step3-业务模块的登录检查-注解与拦截器" class="headerlink" title="Step3: 业务模块的登录检查(@注解与拦截器)"></a>Step3: 业务模块的登录检查(@注解与拦截器)</h4><p>1 、由认证中心签发的token如何保存？保存到浏览器的cookie中<br>2 、难道每一个模块都要做一个token的保存功能？ 拦截器<br>3 、如何区分请求是否一定要登录？自定义注解</p><h5 id="拦截器-Interceptor"><a href="#拦截器-Interceptor" class="headerlink" title="拦截器(Interceptor)"></a>拦截器(Interceptor)</h5><p>拦截器原理基于反射,网上很多教程,要注意之前servlet中用过的Fliter和Interceptor(拦截器)的区别—–&gt;<strong>一个是反射,一个是和Servlet有关</strong></p><p><strong>HandlerInterceptor-&gt;Spring中提供的拦截器接口</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    public interface HandlerInterceptor &#123;</span><br><span class="line"></span><br><span class="line">   &#x2F;**</span><br><span class="line">     * 预处理回调方法，实现处理器的预处理（如检查登陆），第三个参数为响应的处理器，自定义Controller</span><br><span class="line">     * 返回值：true表示继续流程（如调用下一个拦截器或处理器）；false表示流程中断（如登录检查失败），不会继续调用其他的拦截器或处理器，此时我们需要通过response来产生响应；</span><br><span class="line">   *&#x2F;</span><br><span class="line">    boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)</span><br><span class="line">            throws Exception;</span><br><span class="line"></span><br><span class="line">   &#x2F;**</span><br><span class="line">     * 后处理回调方法，实现处理器的后处理（但在渲染视图之前），此时我们可以通过modelAndView（模型和视图对象）对模型数据进行处理或对视图进行处理，modelAndView也可能为null。</span><br><span class="line">   *&#x2F;</span><br><span class="line">    void postHandle(</span><br><span class="line">            HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span><br><span class="line">            throws Exception;</span><br><span class="line"></span><br><span class="line">   &#x2F;**</span><br><span class="line">    * 整个请求处理完毕回调方法，即在视图渲染完毕时回调，如性能监控中我们可以在此记录结束时间并输出消耗时间，还可以进行一些资源清理，类似于try-catch-finally中的finally，但仅调用处理器执行链中</span><br><span class="line">   *&#x2F;</span><br><span class="line">    void afterCompletion(</span><br><span class="line">            HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span><br><span class="line">            throws Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>1、定义登录检查注解<br><strong>LoginRequired.class:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface LoginRequired &#123;</span><br><span class="line"></span><br><span class="line">    boolean loginSuccess() default true;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2、自定义拦截器，继承成HandlerInterceptorAdapter,通过重写它的preHandle方法，业务代码前的校验工作<br><strong>AuthInterceptor.class:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class AuthInterceptor extends HandlerInterceptorAdapter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;</span><br><span class="line">        &#x2F;&#x2F; 拦截代码</span><br><span class="line">        &#x2F;&#x2F; 判断被拦截的请求的访问的方法的注解(是否时需要拦截的)</span><br><span class="line">        HandlerMethod hm &#x3D; (HandlerMethod) handler;</span><br><span class="line">        LoginRequired methodAnnotation &#x3D; hm.getMethodAnnotation(LoginRequired.class);</span><br><span class="line"></span><br><span class="line">        StringBuffer url &#x3D; request.getRequestURL();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 没有LoginRequired则直接放行</span><br><span class="line">        if (methodAnnotation &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;先从cookie中查找有没有保存的token信息</span><br><span class="line">        String token &#x3D; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        String oldToken &#x3D; CookieUtil.getCookieValue(request, &quot;oldToken&quot;, true);</span><br><span class="line">        if (StringUtils.isNotBlank(oldToken)) &#123;</span><br><span class="line">            token &#x3D; oldToken;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String newToken &#x3D; request.getParameter(&quot;token&quot;);</span><br><span class="line">        if (StringUtils.isNotBlank(newToken)) &#123;</span><br><span class="line">            token &#x3D; newToken;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 是否必须登录</span><br><span class="line">        boolean loginSuccess &#x3D; methodAnnotation.loginSuccess();&#x2F;&#x2F; 获得该请求是否必登录成功</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 进入认证中心进行验证</span><br><span class="line">        String success &#x3D; &quot;fail&quot;;</span><br><span class="line">        Map&lt;String,String&gt; successMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        if(StringUtils.isNotBlank(token))&#123;</span><br><span class="line">            String ip &#x3D; request.getHeader(&quot;x-forwarded-for&quot;);&#x2F;&#x2F; 通过nginx转发的客户端ip</span><br><span class="line">            if(StringUtils.isBlank(ip))&#123;</span><br><span class="line">                ip &#x3D; request.getRemoteAddr();&#x2F;&#x2F; 从request中获取ip</span><br><span class="line">                if(StringUtils.isBlank(ip))&#123;</span><br><span class="line">                    ip &#x3D; &quot;127.0.0.1&quot;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            String successJson  &#x3D; HttpclientUtil.doGet(&quot;http:&#x2F;&#x2F;passport.gmall.com:8085&#x2F;verify?token&#x3D;&quot; + token+&quot;&amp;currentIp&#x3D;&quot;+ip);</span><br><span class="line"></span><br><span class="line">            successMap &#x3D; JSON.parseObject(successJson,Map.class);</span><br><span class="line"></span><br><span class="line">            success &#x3D; successMap.get(&quot;status&quot;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (loginSuccess) &#123;</span><br><span class="line">            &#x2F;&#x2F; 必须登录成功才能使用</span><br><span class="line">            if (!success.equals(&quot;success&quot;)) &#123;</span><br><span class="line">                &#x2F;&#x2F;重定向会passport登录</span><br><span class="line">                StringBuffer requestURL &#x3D; request.getRequestURL();</span><br><span class="line">                response.sendRedirect(&quot;http:&#x2F;&#x2F;passport.gmall.com:8085&#x2F;index?ReturnUrl&#x3D;&quot;+requestURL);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 需要将token携带的用户信息写入</span><br><span class="line">            request.setAttribute(&quot;memberId&quot;, successMap.get(&quot;memberId&quot;));</span><br><span class="line">            request.setAttribute(&quot;nickname&quot;, successMap.get(&quot;nickname&quot;));</span><br><span class="line">            &#x2F;&#x2F;验证通过，覆盖cookie中的token</span><br><span class="line">            if(StringUtils.isNotBlank(token))&#123;</span><br><span class="line">                CookieUtil.setCookie(request,response,&quot;oldToken&quot;,token,60*60*2,true);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; 没有登录也能用，但是必须验证</span><br><span class="line">            if (success.equals(&quot;success&quot;)) &#123;</span><br><span class="line">                &#x2F;&#x2F; 需要将token携带的用户信息写入</span><br><span class="line">                request.setAttribute(&quot;memberId&quot;, successMap.get(&quot;memberId&quot;));</span><br><span class="line">                request.setAttribute(&quot;nickname&quot;, successMap.get(&quot;nickname&quot;));</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F;验证通过，覆盖cookie中的token</span><br><span class="line">                if(StringUtils.isNotBlank(token))&#123;</span><br><span class="line">                    CookieUtil.setCookie(request,response,&quot;oldToken&quot;,token,60*60*2,true);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CookieUtil等工具包地址<br><a target="_blank" rel="noopener" href="https://github.com/YellowRifle/Web-Utils">https://github.com/YellowRifle/Web-Utils</a></p><div class="post-announce">感谢您的阅读，本文由 <a href="https://yellowrifle.github.io">YellowRifle</a> 版权所有。如若转载，请注明出处：YellowRifle（<a href="https://yellowrifle.github.io/2019/11/04/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/">https://yellowrifle.github.io/2019/11/04/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2019/10/23/ReetrantLock/" title="ReetrantLock的看法"><i class="iconfont icon-prev"></i>ReetrantLock的看法</a></div><div class="post__prev post__prev--right"><a href="/2019/11/04/%E5%A0%86%E6%8E%92%E5%BA%8F/" title="堆排序">堆排序<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%9D%82%E9%A1%B9/">杂项</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Web/">Web</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Redis/">Redis</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Java/">Java</a><span class="block-list-count">7</span><ul class="block-list-child"><li class="block-list-item"><a class="block-list-link" href="/categories/Java/Java-Lock/">Java Lock</a><span class="block-list-count">3</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Java/Java-Basic/">Java Basic</a><span class="block-list-count">3</span></li></ul></li><li class="block-list-item"><a class="block-list-link" href="/categories/Gradle/">Gradle</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Golang/">Golang</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Algorithm/">Algorithm</a><span class="block-list-count">3</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2020/09/01/hello-world/" title="Hello World"><div class="item__cover"><img src="undefined" alt="Hello World"></div><div class="item__info"><h3 class="item__title">Hello World</h3><span class="item__text">2020-09-01</span></div></a></li><li class="latest-post-item"><a href="/2019/11/11/%E9%98%BF%E9%87%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BD%BF%E7%94%A8/" title="阿里服务器使用"><div class="item__cover"><img src="images/杂项/alibaba/headindex.png" alt="阿里服务器使用"></div><div class="item__info"><h3 class="item__title">阿里服务器使用</h3><span class="item__text">2019-11-11</span></div></a></li><li class="latest-post-item"><a href="/2019/11/05/Sychronized/" title="Sychronized(对象锁)"><div class="item__cover"><img src="/images/lock/Sychronized/headindex.jpg" alt="Sychronized(对象锁)"></div><div class="item__info"><h3 class="item__title">Sychronized(对象锁)</h3><span class="item__text">2019-11-05</span></div></a></li><li class="latest-post-item"><a href="/2019/11/05/Volatile/" title="Volatile"><div class="item__cover"><img src="/images/lock/volatile/headindex.png" alt="Volatile"></div><div class="item__info"><h3 class="item__title">Volatile</h3><span class="item__text">2019-11-05</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Garbage-Collector/">Garbage Collector</a></li><li class="tag-item"><a class="tag-link" href="/tags/Gradle/">Gradle</a></li><li class="tag-item"><a class="tag-link" href="/tags/Lock/">Lock</a></li><li class="tag-item"><a class="tag-link" href="/tags/NIO/">NIO</a></li><li class="tag-item"><a class="tag-link" href="/tags/OOP/">OOP</a></li><li class="tag-item"><a class="tag-link" href="/tags/Redis/">Redis</a></li><li class="tag-item"><a class="tag-link" href="/tags/Sychronized/">Sychronized</a></li><li class="tag-item"><a class="tag-link" href="/tags/Volatile/">Volatile</a></li><li class="tag-item"><a class="tag-link" href="/tags/android/">android</a></li><li class="tag-item"><a class="tag-link" href="/tags/login/">login</a></li><li class="tag-item"><a class="tag-link" href="/tags/sort/">sort</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，主要用于分享日常学习、生活及工作的一些心得总结，欢迎点击右下角订阅 rss。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Chengdu, Sichuan Province, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>984367065@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/images/websource/avator.jpg" alt="logo" title="YellowRifle"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2019 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/YellowRifle" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="984367065@qq.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>